#include "Chip8.h"
#include "Chip8Types.h"
#include "Memory.h"
#include "CPU.h"
#include "ROM.h"
#include "Keyboard.h"
#include "Display.h"
#include "altera_avalon_pio_regs.h"
#include "system.h"

static uint8_t Chip8Fonts[16][5] = {
	{0xF0, 0x90, 0x90, 0x90, 0xF0},		// 0
	{0x20, 0x60, 0x20, 0x20, 0x70},		// 1
	{0xF0, 0x10, 0xF0, 0x80, 0xF0},		// 2
	{0xF0, 0x10, 0xF0, 0x10, 0xF0},		// 3
	{0x90, 0x90, 0xF0, 0x10, 0x10},		// 4
	{0xF0, 0x80, 0xF0, 0x10, 0xF0},		// 5
	{0xF0, 0x80, 0xF0, 0x90, 0xF0},		// 6
	{0xF0, 0x10, 0x20, 0x40, 0x40},		// 7
	{0xF0, 0x90, 0xF0, 0x90, 0xF0},		// 8
	{0xF0, 0x90, 0xF0, 0x10, 0xF0},		// 9
	{0xF0, 0x90, 0xF0, 0x90, 0x90},		// A
	{0xE0, 0x90, 0xE0, 0x90, 0xE0},		// B
	{0xF0, 0x80, 0x80, 0x80, 0xF0},		// C
	{0xE0, 0x90, 0x90, 0x90, 0xE0},		// D
	{0xF0, 0x80, 0xF0, 0x80, 0xF0},		// E
	{0xF0, 0x80, 0xF0, 0x80, 0x80}		// F
};



void initChip8(void)
{
	uint16_t switch_control = 0;
	switch_control = IORD_ALTERA_AVALON_PIO_DATA(SWITCH_CONTROL_BASE);

	initRAM(ADDRESS_START_OF_FONT, &(Chip8Fonts[0][0]), sizeof(Chip8Fonts));
	initRAM(ADDRESS_START_OF_PROGRAM, getROMData(switch_control), getROMSize(switch_control));
	initCPU(ADDRESS_START_OF_PROGRAM, ADDRESS_START_OF_FONT);
	initKeypadMap(getROMKeypad(switch_control));
	initPress();
	clearDisplay();
}

void runChip8(void)
{
	processPress();
	runCPU();
}
